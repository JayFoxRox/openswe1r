; Copyright 2017 OpenSWE1R Maintainers
; Licensed under GPLv2 or any later version
; Refer to the included LICENSE.txt file.

; Build using: nasm uc_vm_loader.asm -o build/uc_vm_loader
; Inspect using (16 bit): objdump -D -bbinary -mi8086 -Mintel --adjust-vma=0xFFFFF0000 build/uc_vm_loader 
; Inspect using (32 bit): objdump -D -bbinary -mi386 -Mintel --adjust-vma=0xFFFFF0000 build/uc_vm_loader 

org 0xFFFFF000

[bits 32]

halt:
  hlt

[bits 16]

start:
  o32 lgdt [cs:gdtr]
  mov eax, cr0
  or al, 1
  mov cr0, eax
  jmp long 0x8:reload_cs

[bits 32]
reload_cs:
  xor eax, eax
  mov al, 0x10
  mov ds, eax
  mov es, eax
  mov ss, eax
  hlt

align 16
gdtr:
  dw 0x18
  dd gdt

  
align 16
gdt:
  ;db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  ;db 0xff, 0xff, 0x00, 0x00, 0x00, 0x9A, 0xCF, 0x00
  ;db 0xff, 0xff, 0x00, 0x00, 0x00, 0x92, 0xCF, 0x00

  db 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  db 0xff, 0xff, 0x00, 0x00, 0x00, 0x9b, 0xcf, 0x00
  db 0xff, 0xff, 0x00, 0x00, 0x00, 0x93, 0xcf, 0x00

[bits 16]
times 0xFF0-($-$$) db 0x90
  jmp start
times 0x1000-($-$$) db 0x90

